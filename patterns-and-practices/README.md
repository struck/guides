Coding Patterns and Best Practices
==================================

A guide for programming well.

General
-------

* Don't duplicate the functionality of a built-in library.
* Prefer clear, single-task/single-focus libraries to "grab bag" libraries 
  containing many parts.
* Don't swallow exceptions or "fail silently."
* Don't write code that guesses at future functionality.

Object-Oriented Design
----------------------

* Avoid global variables.
* Avoid long parameter lists.
* Limit collaborators of an object (entities an object depends on).
* Limit an object's dependencies (entities that depend on an object).
* Prefer composition over inheritance.
* Prefer small methods. Between one and five lines is best.
* Prefer small objects with a single, well-defined responsibility. When an
  object exceeds 100 lines, it may be doing too many things.
* [Tell, don't ask](http://goo.gl/Ztawt).

Git
---

- Perform work in a feature branch.
- Delete feature branches from remotes after those branches are irrelevant.
- Tag major releases of a web app. Particular examples include beta and alpha
  releases, major launches and large feature deployments.
- Write [verbose and descriptive commit messages](http://goo.gl/w11us).
- Use imperative sentence structure in your commit message: "Fix bug" and 
  not "Fixed bug" or "Fixes bug."  This convention matches up with commit 
  messages generated by commands like git merge and git revert.
- Use basic markdown formatting in commit messages including newlines, lists, 
  ems, strongs, and etc.
- Prefer to write commit messages using a text editor over inline in commit 
  commands.

Ruby
----

* <del>Avoid optional parameters. Does the method do too much?</del>
* Avoid monkey-patching.
* Prefer classes to modules when designing functionality that is shared by
  multiple models.
* Prefer `private` when indicating scope. Use `protected` only with comparison
  methods like `def ==(other)`, `def <(other)`, and `def >(other)`.

Rake
----

* Write Rake (or Ant or Jake) tasks that call Ruby code. Avoid long processing
  of procedural tasks within a Rake task when the functionality can be handled
  by a class or other Ruby construct.

Ruby Gems
---------

* Declare dependencies in the `<PROJECT_NAME>.gemspec` file.
* Reference the `gemspec` in the `Gemfile`.
* Use [Appraisal](http://github.com/thoughtbot/appraisal) to test the gem
  against multiple versions of gem dependencies (such as Rails in a Rails
  engine).
* Use [Bundler](http://gembundler.com/) to manage the gem's dependencies.
* For open source gems, use [Travis CI](http://travisci.org) for 
  Continuous Integration, indicators showing whether GitHub pull requests 
  can be merged, and to test against multiple Ruby versions.

Rails
-----

* Avoid bypassing validations with methods like `save(validate: false)`,
  `update_attribute`, and `toggle`.
* <del>Avoid instantiating more than one object in controllers.</del>
* Avoid naming methods after database columns in the same class.
* Don't change a migration after it has been merged into master if the desired
  change can be solved with another migration.
* Avoid referencing a model class directly from a view.
* Don't use SQL or SQL fragments (`where('inviter_id IS NOT NULL')`) outside
  of models. 
* If there are default values, set them in migrations.
* Keep `db/schema.rb` or `db/development_structure.sql` under version control.
* Use only one instance variable in each view.
* Use SQL, not `ActiveRecord` models, in migrations.
* Use the [`.ruby-version`](https://gist.github.com/fnichol/1912050) file
  convention to specify the Ruby version and patch level for a project.
* Use `_url` suffixes for named routes in mailer views and
  [redirects](http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.30).
  Use `_path` suffixes for named routes everywhere else.
* Validate the associated `belongs_to` object (`user`), not the database
  column (`user_id`).
* Prefer [decorators](https://github.com/drapergem/draper) over helpers.
* Use decorators on models when extensive custom methods are required.

Data
----

* Write and test rollbacks when writing data migrations.
* Break seed data out into seperate tasks, so that any single of the group 
  can be seeded independently.
* Write a flexible set of fpo data seed tasks with any app with a database.
* Keep fpo data seeding seperate from standard seeding scripts.
* Don't store sensitive values in a database or data-store without encryption.
* Use the right terms for data seeding. Use `seeds` as a general term, but split 
  application data out into `bootstrap` (essential to the app but not typically 
  edited), `fpo` (data to be replaced by final content), and `seeds` (data that
  will typically be edited and is final content).

Testing
-------

* Prefer RSpec and FactoryGirl
* <del>Avoid `its`, `let`, `let!`, `specify`, `before`, and `subject` in RSpec.</del>
* Avoid using instance variables in tests.
* <del>Don't test private methods.</del>
* Use [stubs and spies](http://goo.gl/EciDJ) (not mocks) in isolated tests.
* Use a single level of abstraction within scenarios.
* Use an `it` example or test method for each execution path through the method.
* Use [assertions about state] for incoming messages.
* Use stubs and spies to assert you sent outgoing messages.

[assertions about state]: https://speakerdeck.com/skmetz/magic-tricks-of-testing-railsconf?slide=51

Bundler
-------

* Specify the [Ruby version](http://gembundler.com/v1.3/gemfile_ruby.html) to be
  used on the project in the `Gemfile`.
* Use a [pessimistic
  version](http://robots.thoughtbot.com/post/35717411108/a-healthy-bundle#pessimistic-version)
  in the `Gemfile` for gems that follow semantic versioning, such as `rspec`,
  `factory_girl`, and `capybara`.
* Use a
  [versionless](http://robots.thoughtbot.com/post/35717411108/a-healthy-bundle#versionless)
  `Gemfile` declarations for gems that are safe to update often, such as pg, thin,
  and debugger.
* Use an [exact
  version](http://robots.thoughtbot.com/post/35717411108/a-healthy-bundle#exact-version)
  in the `Gemfile` for fragile gems, such as Rails.

File Organization
-----------------

* Store 3rd party libraries imported into a project in a vendor/ directory.
  (Example JS lib in a Rails project: app/assets/javascripts/vendor/underscore.js)
* Don't commit to version control modifications made to 3rd party libraries. 
  Write patches instead, but avoid monkey patches as well.


Database
--------

* Avoid multicolumn indexes in Postgres. It [combines multiple
  indexes](http://goo.gl/pY3Po) efficiently. Optimize later with a [compound
  index if needed](http://www.postgresql.org/docs/9.2/static/indexes-bitmap-scans.html).
* Consider a [partial index](http://goo.gl/YC8Jt) for queries on booleans.
* <del>Constrain most columns as [`NOT NULL`](http://goo.gl/0GeBr)</del>.

Background Jobs
---------------

* Use background jobs for heavy tasks, such as email delivery, image processing, warming caches, firing web hooks, and etc.
* Store IDs, not `ActiveRecord` objects for cleaner serialization, then re-find
  the `ActiveRecord` object in the `perform` method.

Assets
------

* When using markup processing or dynamic views and asset hashing is available, always use it. This enables flexability down the road for edge caching and invalidating.

Caching
-------

* Use caching
* Prefer ActionCache over PageCache (Rails)

Email
-----

* Use [SendGrid](http://goo.gl/Kxu9W) or [Amazon SES](http://goo.gl/A5jAA) to
  deliver email in staging and production environments.
* Use a tool like [mail_view](http://goo.gl/HhX8y) to look at each created or
  updated mailer view before merging.
* [Intercept](http://goo.gl/Fl86y) emails on development and staging environments and send to a controlled inbox.
* Prefer [mailer interception](http://goo.gl/Fl86y) over strict `perform_deliveries = false`

Testing
-------

* Write tests.
* <del>Disable real HTTP requests to external services with
  `WebMock.disable_net_connect!`.</del>
* <del>Test background jobs with a [`Delayed::Job` matcher](http://goo.gl/bzBlN).</del>
* Test background jobs.
* Use a [Fake](http://goo.gl/YR7Hh) to stub requests to external services.
* Use integration tests to execute the entire app.
* Use non-[SUT](http://goo.gl/r5Ti2) methods in expectations when possible.

Monitoring
----------

* Use monitoring, and initialize it at the same time a server environment is initialized. (Don't wait for 11th hour)

Deployment
----------

* Prefer writing tasks to handle deployment programmatically over manually ftp-ing files or
  manually running `git pull origin master` commands on remote machines.
* Write deployment tasks to explicitely allow for multiple environments. (Don't assume an 
  environment or require changing values for each deployed environment.) Example: A rake task 
  for each environment: `rake deploy:staging` and `rake deploy:production`.

JavaScript
----------

* Use CoffeeScript.
* Concatenate JS into one or few `.js` files.
* Load polyfills as independent js files when necessary for B-grade or feature-poor browsers.
* Prefer loading JavaScript files at the bottom of html files instead of in the head.

HTML
----

* Don't use a reset button for forms.
* Prefer cancel links to cancel buttons.

CSS
---

* Use Sass.

Browsers
--------

* Don't support clients without Javascript.
* Don't support IE6 or IE7.

Objective-C
-----------

* Prefer categories on `Foundation` classes to helper methods.
* Prefer string constants to literals when providing keys or key paths to methods.
